---
apiVersion: v1
kind: ConfigMap
metadata:
  name: codest-api-config
  labels:
    app: codest-api
data:
  application.conf: |
    openapi {
        management {
            file = "openapi/server/codest-api-openapi.yaml"
            enabled = true
            endpoint = "/openapi"
            swaggerui {
                enabled = true
                endpoint = "/swagger-ui"
            }
        }
    }

    kafka {
        cacheInvalidateConsumer {
            topics = "codest.cache.invalidate"
            pollTimeout = 250ms
            threads = 4
            driverProperties {
                bootstrap.servers: """
                    kafka:9092
                """
                "group.id": "codest.runner.pod_name"
            }
        }
        runConsumer {
            topics = "codest.runner.response"
            pollTimeout = 250ms
            threads = 4
            driverProperties {
                bootstrap.servers: """
                    kafka:9092
                """
                "group.id": "codest.runner"
            }
        }
        producer {
             driverProperties {
                bootstrap.servers: """
                    kafka:9092
                """
             }
             send-topic {
                  topic = "codest.runner.request"
             }
             cache-invalidate-topic {
                topic = "codest.cache.invalidate"
             }
        }
    }

    db {
        jdbcUrl = "jdbc:postgresql://dev-pg-postgresql:5432/codest"
        username = "postgres"
        password = "cG9zdGdyZXM="
        schema = "public"
        poolName = "codest-task"
        maxPoolSize = 10
        minIdle = 2
    }

    security {
        key: "dGhpcyBpcyBzb21lIGp3dCBzZWNyZXR0aGlzIGlzIHNvbWUgand0IHNlY3JldA=="
    }

    cache {
        getTask {
             expireAfterWrite = "10000s"
             expireAfterAccess = "10000s"
             initialSize = 10
             maximusSize = 1000
        }
        testsByTaskId {
             expireAfterWrite = "10000s"
             expireAfterAccess = "10000s"
             initialSize = 10
             maximusSize = 1000
        }
        getAttempt {
             expireAfterWrite = "60s"
             expireAfterAccess = "60s"
             initialSize = 100
             maximusSize = 10000
        }
    }

---

apiVersion: v1
kind: Service
metadata:
  name: svc-codest-api
spec:
  type: ClusterIP
  ports:
  - port: 8080
    targetPort: 8080
  selector:
    app: codest-api
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: codest-api
spec:
  replicas: 2
  selector:
    matchLabels:
      app: codest-api
  revisionHistoryLimit: 2
  progressDeadlineSeconds: 300
  minReadySeconds: 10
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 2
  template:
    metadata:
      name: codest-api
      labels:
        app: codest-api
    spec:
      containers:
      - name: codest-api-ctr
        image: ghcr.io/r3nnyweb/codest-api:latest
        ports:
        - containerPort: 8080
        livenessProbe:
          httpGet:
            path: /system/liveness
            port: 8085
            scheme: HTTP
          initialDelaySeconds: 15
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /system/readiness
            port: 8085
            scheme: HTTP
          initialDelaySeconds: 15
          periodSeconds: 10
        resources:
          limits:
            memory: 512Mi
            cpu: 0.5
        env:
          - name: JAVA_OPTS
            value: >-
              -Dconfig.file=/opt/app/config/application.conf
              -Xmx256m
              -XX:+AlwaysActAsServerClassMachine
              -XX:+UseG1GC
        volumeMounts:
          - name: config
            mountPath: "/opt/app/config/"
            readOnly: true
      volumes:
          # You set volumes at the Pod level, then mount them into containers inside that Pod
        - name: config
          configMap:
              # Provide the name of the ConfigMap you want to mount.
            name: codest-api-config
